
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>애드투페이퍼 서비스 구성 Stack</title>
    
    <meta name="author" content="Add2paper">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta property="og:title" content="Add2paper Engineering Blog"/>
    <meta property="og:type" content="blog"/>

    
    <meta property="og:url" content="http://add2paper.github.io/2013/04/17/Add2paper-Technology-Stack"/>
    <meta property="og:site_name" content="애드투페이퍼 서비스 구성 Stack - Add2paper Engineering Blog"/>
    

    

    
      <meta property="og:description" content="애드투페이퍼 서비스 개발 및 운영 경험을 공유하는 블로그입니다."/>
    

    <meta property="og:image" content="http://cdn.add2paper.com/media/image/2013/11/138475635572882.png" />

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.2.2.2.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div id="fb-root"></div>
    <script>(function(d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return;
      js = d.createElement(s); js.id = id;
      js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=434811836608336";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));</script>

    <div class="navbar">
      <div class="navbar-inner">
        <div class="container-narrow">
          <a class="brand" href="/">Add2paper Engineering Blog</a>
          <ul class="nav">
            <li><a href="/">Home</a></li>
            <li><a href="/archive.html">Archive</a></li>
            <li><a href="/rss.xml">RSS</a></li>
            <!--<li><a href="/atom.xml">Atom</a></li>-->
            


  



          </ul>
        </div>
      </div>
    </div>

    <div class="container-narrow">

      <div class="content">
        
<div class="page-header">
  <h1>애드투페이퍼 서비스 구성 Stack </h1>
</div>

<div class="row-fluid post-full">
  <div class="span12">
    <div class="date">
      <strong>17 April 2013</strong>
    </div>
    <div class="content">
      <p>안녕하세요, <a href='http://www.add2paper.com'>애드투페이퍼</a>에서 개발을 담당하고 있는 <a href='http://www.leekchan.com'>이경찬</a>입니다. 애드투페이퍼를 개발 및 운영하면서 경험하고 해결한 사항들을 공유하고자 블로그를 만들었습니다. 첫 번째 포스트에서는 애드투페이퍼 서비스 구성 Stack에 대해서 공유하고자 합니다.</p>
<br />
<h2 id='overview'>Overview</h2>
<br />
<h3 id='_'>서버 구성</h3>

<p>애드투페이퍼 서비스는 KT Ucloud 인스턴스 7대 위에서 동작하고 있습니다. 각 인스턴스의 역할은 다음과 같습니다.</p>

<ol>
<li>로드밸런서 1대 (2vCore 2GB | Ubuntu 11.04 | HAProxy)</li>

<li>어플리케이션 서버 3대 (4vCore 4GB | Ubuntu 11.04 | Gunicorn, Django, Supervisor)</li>

<li>DB 2대 (4vCore 4GB | CentOS 5.4 | MySQL Master-Slave Replication 구성)</li>

<li>캐시 + 워커 서버 1대 (4vCore 8GB | Ubuntu 11.04 | Memcached, Celery, Redis, Supervisor)</li>
</ol>

<p>현재는 <a href='http://en.wikipedia.org/wiki/Single_point_of_failure'>SPOF</a> 가 많지만, 점진적으로 개선 중입니다. 궁극적으로는 무중단 인프라를 구축하는 것이 목표입니다. 현재 어플리케이션 서버와 DB는 Failover가 되고, HAProxy 이중화 작업을 최우선 과제로 진행 중입니다.</p>
<br />
<h3 id='_'>서비스 구성</h3>

<p>애드투페이퍼 서비스 구성은 다음과 같습니다.</p>

<ol>
<li>애드투페이퍼 웹서비스 &#160;</li>

<li>애드투페이퍼 앱 API 백엔드 &#160;</li>

<li>프린터 API 백엔드 &#160;</li>

<li>광고주용 실시간 리포트 사이트 &#160;</li>

<li>프린터관리자용 실시간 프린팅 및 정산 정보 확인 사이트 &#160;</li>

<li>내부 관리용 사이트 &#160;</li>
</ol>

<p>애드투페이퍼 초반에는 일부 시스템이 ASP, PHP로 되어있었지만 2012년 하반기부터 기존 코드 및 신규 코드들을 Python + Django로 작성하여 현재는 100% Python + Django 코드로 동작중입니다.</p>
<br />
<h2 id='application_server_'>Application Server 구성</h2>

<ol>
<li>Python</li>

<li>Django</li>

<li>Nginx</li>

<li>Gunicorn</li>

<li>Supervisor</li>
</ol>

<p>앞서 언급한 것처럼 애드투페이퍼 서비스 코드는 Python, Django로 작성됩니다. 리버스 프록시로는 Nginx, WSGI Container로는 Gunicorn을 사용하고 있습니다. Supervisor는 Gunicorn 프로세스 모니터링 용으로 사용 중입니다.</p>
<br />
<h2 id='cache_'>Cache 구성</h2>

<ol>
<li>Memcached</li>

<li><a href='http://pythonhosted.org/johnny-cache/'>Johnny Cache</a></li>
</ol>

<p>애드투페이퍼 서비스에서는 모든 Database Read Query를 Memcached에 캐시하고 있습니다. 모든 상황에 대해 견고한 Cache Invalidation 로직을 만드는 작업은 매우 많은 시간이 소요되는 작업이므로, Johnny Cache라는 Cache Framework를 사용하고 있습니다. Johnny Cache는 기본적으로 MySQL의 Query Cache와 비슷하게 동작합니다. Johnny Cache Middleware를 등록해 놓으면 Monkey Patch를 통해 SELECT 쿼리가 발생할 때는 쿼리를 Key로 Memcached에 캐시하고, INSERT 또는 UPDATE 쿼리가 발생할 때는 해당 Table에 관계된 Cache들을 자동으로 Invalidation 해줍니다.</p>

<p>백엔드 코드를 작성할 때는 Memcached의 Cache hit ratio를 높이기 위해 SELECT 문의 WHERE절에는 특정한 상수가 들어가는 것을 피하고 있습니다. 또한 어플리케이션상에서 데이터를 가공할 수 있을 때에는 최대한 어플리케이션에서 코드상에서 처리해서 I/O Bound 되는 것을 피하고 있습니다.</p>
<br />
<h2 id='database__storage'>Database / Storage</h2>

<p>데이터베이스는 MySQL 5.5 를 사용하고 있고, Master-Slave 구성으로 2대를 사용하고 있습니다.</p>

<p>서비스상에서 업로드 되는 이미지 및 파일은 Amazon S3 (Tokyo Region)에 저장하고 CDN을 통해 제공하고 있습니다. 광고 이미지를 리사이징 하는 등의 작업은 어플리케이션 서버에서 인메모리로 처리하고 S3에 저장합니다.</p>
<br />
<h2 id='worker_'>Worker 구성</h2>

<ol>
<li>Redis</li>

<li>Celery</li>

<li>Supervisor</li>
</ol>

<p>시간이 걸리는 Task들은 모두 Task Queue를 이용해 비동기로 처리하고 있습니다. Task Queue는 Celery를 이용하고 있고 작업들을 저장하고 분배하는 Broker 용도로 Redis를 사용하고 있습니다. 그리고 Celery 프로세스의 모니터링 용도로 Supervisor를 사용하고 있습니다.</p>
<br />
<h2 id='deployment'>Deployment</h2>
<p>(2014년 3월 27일 업데이트 : 현재는 <a href="http://docs.fabfile.org/en/1.8/">Fabric</a>을 이용하여 배포를 자동화하고 있습니다. Beanstalk 서비스가 Mercurial 제공을 중단하여, 저장소는 Bitbucket을 사용하고 배포 스크립트는 Fabric을 이용하여 작성하여 사용하고 있습니다.) </p>
<p>어플리케이션 배포는 <a href='http://beanstalkapp.com'>beanstalk</a>을 이용해 자동화하고 있습니다. beanstalk 서비스는 Mercurial 저장소를 제공하고 (Git도 제공), 등록된 서버들에 병렬로 접속해서 미리 지정된 SSH Command들을 실행시켜주는 기능을 제공합니다. 배포 시 각 서버에서 실행하는 커맨드는 다음과 같습니다.</p>
<br />
<h3 id='_'>어플리케이션 서버</h3>
<pre>
hg pull
hg update --clean
pip install -r ./requirements.txt
supervisorctl status gunicorn | sed "s/.*[pid ]\([0-9]\+\)\,.*/\1/" | xargs kill -HUP
</pre>
<p>저장소에서 최신 코드를 받아온 뒤, 새로 추가된 모듈들을 설치한 후 Gunicorn에 -HUP signal을 보내서 graceful reload 기능(처리 중인 요청을 모두 처리하고 프로세스를 재시작함)을 실행시킵니다. supervisorctl reload 커맨드로 Gunicorn을 재시작하면 재시작하는 도중에는 요청을 받을 수 없는 상태가 되므로, pid를 읽어와서 -HUP 시그널을 보내는 방식으로 재시작시켜서 무중단으로 코드를 변경하고 있습니다.</p>
<br />
<h3 id='___'>캐시 + 워커 서버</h3>
<pre>
hg pull
hg update --clean
pip install -r ./requirements.txt
python ./manage.py migrate
supervisorctl reload
</pre>
<p>캐시 + 워커 서버에서는 <a href='http://south.aeracode.org/'>South</a>의 migrate 커맨드를 실행시켜서 데이터베이스를 마이그레이션하는 작업을 담당하고 있습니다. 모든 작업이 끝난 후에는 supervisorctl reload 명령을 실행시켜서 Celery 프로세스를 재시작 합니다.</p>
<br />
<h2 id='server_monitoring'>Server Monitoring</h2>

<p>서버 모니터링은 <a href='http://www.datadoghq.com/'>datadog</a> 서비스를 이용해서 하고 있습니다. 실시간 모니터링이 가능하고 대시보드를 만들어 각 서버의 CPU, Memory, Network 사용량 등을 원하는 대로 가공해서 모아서 볼 수 있어서 효과적입니다.</p>
<br />
<h2 id='and_more'>And more?</h2>

<p>지금까지 저희 서비스 구성 Stack에 대해 공유 드렸는데요, 애드투페이퍼 앱에도 흥미로운 공유사항들이 많이 있습니다. 살짝 공유하자면 저희 앱은 HTML, Javascript로 제작되어서 단일 코드 베이스로 iOS / Android 플랫폼 양쪽에 배포하고 있는데요, 후속 포스팅에서 자세히 공유하도록 하겠습니다.</p>

<p>감사합니다.</p>

<p>&#32;<br /><br /></p>
<div data-send='true' data-show-faces='true' class='fb-like' data-width='450' data-href='http://add2paper.github.io' />
    </div>

  

  

    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev disabled"><a>&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next"><a href="/2014/03/27/Add2paper-Recruiting" title="애드투페이퍼 서비스를 같이 혁신할 엔지니어분을 모십니다.">Next &rarr;</a></li>
      
      </ul>
    </div>
  </div>
</div>


      </div>



      <hr />
      <footer>
        <p>&copy; 2013 Add2paper
        </p>
      </footer>

    </div>

    


  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-31893133-4']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>



  </body>
</html>

